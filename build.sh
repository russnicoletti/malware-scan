#!/usr/bin/env bash

WORKSPACE="$(pwd)"

PROJECT_VERSION_MINOR=`mvn org.apache.maven.plugins:maven-help-plugin:2.1.1:evaluate -Dexpression=project.version |grep -Ev '(^\[|Download\w+:)'| sed 's/\([0-9]*\)\.\([0-9]*\)\.\([0-9]*\).*/\1.\2.0/'`
MALWARE_SCAN_VERSION="${PROJECT_VERSION_MINOR}"

echo "MALWARE_SCAN_VERSION=${MALWARE_SCAN_VERSION}"

# Expand the deploy_manifest.yml
perl -p -e 's/\${MALWARE_SCAN_VERSION}/'$MALWARE_SCAN_VERSION'/g' deploy_manifest.yaml.tpl > deploy_manifest.yaml

mvn clean install
# Using $? we get here the exit code from the last command, in this case 'mvn clean install'
# if it is not 0, then there was an error running it and we should abort this script.
if [ $? -gt 0 ]; then
    echo "*****************************************************"
    echo "****   Maven build failed, aborting this process."
    exit 1
fi
