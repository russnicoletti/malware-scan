package com.symphony.malware.scan.controller;

import com.epages.restdocs.apispec.MockMvcRestDocumentationWrapper;
import com.epages.restdocs.apispec.ResourceSnippetParameters;
import com.symphony.exceptions.service.ForbiddenRequestException;
import com.symphony.malware.scan.exception.MalwareScanFileNotFoundException;
import com.symphony.malware.scan.model.ConversationDetailsDto;
import com.symphony.malware.scan.model.FileInfoDto;
import com.symphony.malware.scan.model.MalwareScanFileStateDto;
import com.symphony.malware.scan.model.MalwareScanFileStatesHistoryDto;
import com.symphony.malware.scan.service.EntitleableActionAuthorizer;
import com.symphony.malware.scan.service.MalwareScanStateService;
import org.junit.After;
import org.junit.Before;
import org.junit.Rule;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.MockitoJUnitRunner;
import org.springframework.restdocs.JUnitRestDocumentation;
import org.springframework.test.web.servlet.MockMvc;
import org.springframework.test.web.servlet.setup.MockMvcBuilders;

import javax.servlet.http.HttpServletRequest;
import java.time.Instant;
import java.util.ArrayList;
import java.util.List;
import java.util.UUID;

import static com.epages.restdocs.apispec.ResourceDocumentation.resource;
import static com.symphony.data.common.roles.entitlableactions.EntitleableActionID.MANAGE_EXPRESSION_FILTERS;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.eq;
import static org.mockito.Mockito.doThrow;
import static org.mockito.Mockito.verify;
import static org.mockito.Mockito.verifyNoMoreInteractions;
import static org.mockito.Mockito.when;
import static org.springframework.restdocs.mockmvc.MockMvcRestDocumentation.document;
import static org.springframework.restdocs.mockmvc.MockMvcRestDocumentation.documentationConfiguration;
import static org.springframework.restdocs.mockmvc.RestDocumentationRequestBuilders.get;
import static org.springframework.restdocs.operation.preprocess.Preprocessors.preprocessRequest;
import static org.springframework.restdocs.operation.preprocess.Preprocessors.preprocessResponse;
import static org.springframework.restdocs.operation.preprocess.Preprocessors.prettyPrint;
import static org.springframework.restdocs.payload.PayloadDocumentation.fieldWithPath;
import static org.springframework.restdocs.payload.PayloadDocumentation.responseFields;
import static org.springframework.restdocs.payload.PayloadDocumentation.subsectionWithPath;
import static org.springframework.restdocs.request.RequestDocumentation.parameterWithName;
import static org.springframework.restdocs.request.RequestDocumentation.pathParameters;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.content;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.header;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;

/**
 * @author anton.g
 */
@RunWith(MockitoJUnitRunner.class)
public class MalwareScanStateControllerTest {

   @Mock
   private MalwareScanStateService scanStateService;

   @Mock
   private EntitleableActionAuthorizer entitleableActionAuthorizer;

   @InjectMocks
   private MalwareScanStateController controller;

   private MockMvc mockMvc;

   @Rule
   public JUnitRestDocumentation restDocumentation = new JUnitRestDocumentation("target/generated-snippets");

   @Before
   public void setup() throws Exception {
      mockMvc = MockMvcBuilders
              .standaloneSetup(controller)
              .setControllerAdvice(new MalwareScanStateControllerAdvice())
              .apply(documentationConfiguration(this.restDocumentation))
              .build();
   }

   @Test
   public void getMalwareAttachmentStateHistory_Success() throws Exception {
      // ARRANGE
      String fileId = "1";

      List<MalwareScanFileStateDto> scanStates = new ArrayList<>();
      String filename = UUID.randomUUID().toString();
      long fileSize = 123L;
      long timestamp = Instant.now().toEpochMilli();
      String scanningState = "OK";

      scanStates.add(new MalwareScanFileStateDto(scanningState, timestamp, MalwareScanFileStateDto.Source.SYMPHONY));
      long timestamp1 = Instant.now().toEpochMilli();
      String scanningState1 = "BAD";

      scanStates.add(new MalwareScanFileStateDto(scanningState1, timestamp1, MalwareScanFileStateDto.Source.CUSTOMER));

      List<ConversationDetailsDto> conversationDetails = new ArrayList<>();
      String streamId = UUID.randomUUID().toString();
      String streamName = UUID.randomUUID().toString();
      String streamType = UUID.randomUUID().toString();
      String messageId = UUID.randomUUID().toString();
      String sender = "test@mail.com";
      conversationDetails.add(new ConversationDetailsDto(streamId, streamName, streamType, messageId, sender));

      String streamId1 = UUID.randomUUID().toString();
      String streamName1 = UUID.randomUUID().toString();
      String streamType1 = UUID.randomUUID().toString();
      String messageId1 = UUID.randomUUID().toString();
      String sender1 = "another-test@mail.com";
      conversationDetails.add(new ConversationDetailsDto(streamId1, streamName1, streamType1, messageId1, sender1));

      FileInfoDto fileInfo = new FileInfoDto(filename, fileId, fileSize);

      MalwareScanFileStatesHistoryDto malwareScanStatesHistory = new MalwareScanFileStatesHistoryDto(fileInfo, scanStates, conversationDetails);
      when(scanStateService.getMalwareAttachmentStatesHistory(fileId)).thenReturn(malwareScanStatesHistory);

      // ACT
      mockMvc.perform(
              get("/api/v1/attachments/malware-scan/states/history/{fileId}", fileId))
              // ASSERT
              .andExpect(status().isOk())
              .andExpect(header().string("Content-Type", "application/json;charset=UTF-8"))
              .andExpect(content().json("{\n" +
                      "    \"fileInfo\": {\n" +
                      "        \"fileName\": \"" + filename + "\",\n" +
                      "        \"fileId\":\"" + fileId + "\",\n" +
                      "        \"fileSize\":" + fileSize + "\n" +
                      "    },\n" +
                      "    \"scanStates\":[\n" +
                      "    {\n" +
                      "        \"scanningState\":\"" + scanningState + "\",\n" +
                      "        \"timestamp\":" + timestamp + ",\n" +
                      "        \"source\": \"Symphony\"\n" +
                      "    },\n" +
                      "    {\n" +
                      "        \"scanningState\":\"" + scanningState1 + "\",\n" +
                      "        \"timestamp\":" + timestamp1 + ",\n" +
                      "        \"source\": \"Customer\"\n" +
                      "    }\n" +
                      "  ],\n" +
                      "    \"conversationDetails\":[\n" +
                      "    {\n" +
                      "        \"streamId\" : \"" + streamId + "\",\n" +
                      "        \"streamName\" : \"" + streamName + "\",\n" +
                      "        \"streamType\" : \"" + streamType + "\",\n" +
                      "        \"sender\":   \"" + sender + "\",\n" +
                      "        \"messageId\" : \"" + messageId + "\"\n" +
                      "    },\n" +
                      "    {\n" +
                      "        \"streamId\" : \"" + streamId1 + "\",\n" +
                      "        \"streamName\" : \"" + streamName1 + "\",\n" +
                      "        \"streamType\" : \"" + streamType1 + "\",\n" +
                      "        \"sender\":   \"" + sender1 + "\",\n" +
                      "        \"messageId\" : \"" + messageId1 + "\"\n" +
                      "    }\n" +
                      "   ]\n" +
                      "}"))
//              .andDo(document("get attachment malware states history - success",
//                      preprocessRequest(prettyPrint()),
//                      preprocessResponse(prettyPrint()),
//                      pathParameters(
//                              parameterWithName("fileId").description("Id of the file for which malware scan history will be retrieved")
//                      ),
//                      responseFields(
//                              subsectionWithPath("fileInfo").description("Metadata of a file"),
//                              subsectionWithPath("scanStates").description("History of malware states of a file"),
//                              subsectionWithPath("conversationDetails").description("Details on a conversation where this file appeared")
//                      ))
//              )
              .andDo(MockMvcRestDocumentationWrapper
                      .document("this is identifier",
                              resource(ResourceSnippetParameters.builder()
                                      .description("some description goes here!!!")
                                      .pathParameters(parameterWithName("fileId").description("Id of the file for which malware scan history will be retrieved"))
                                      .responseFields(
                                              subsectionWithPath("fileInfo").description("Metadata of a file"),
                                              subsectionWithPath("scanStates").description("History of malware states of a file"),
                                              subsectionWithPath("conversationDetails").description("Details on a conversation where this file appeared")
                                      ).build()))
              );

      verify(scanStateService).getMalwareAttachmentStatesHistory(fileId);
      verify(entitleableActionAuthorizer).authorize(any(HttpServletRequest.class), eq(MANAGE_EXPRESSION_FILTERS));
   }

   @Test
   public void getMalwareAttachmentStateHistory_EntitlementCheckFailure() throws Exception {
      String fileId = "1";
      doThrow(ForbiddenRequestException.class).when(entitleableActionAuthorizer).authorize(any(HttpServletRequest.class), eq(MANAGE_EXPRESSION_FILTERS));

      mockMvc.perform(get("/api/v1/attachments/malware-scan/states/history/{fileId}", fileId))
              .andExpect(status().isForbidden())
              .andExpect(header().string("Content-Type", "application/json;charset=UTF-8"))
              .andExpect(content().json("{\"message\":\"Not entitled to access resource: endpoint entitlement check failed\"}"))
              .andDo(document("get attachment malware states history - not entitled",
                      preprocessRequest(prettyPrint()),
                      preprocessResponse(prettyPrint()),
                      pathParameters(
                              parameterWithName("fileId").description("Id of the file for which malware scan history will be retrieved")
                      ),
                      responseFields(
                              fieldWithPath("message").description("Message entitlement check error details")
                      ))
              );

      verify(entitleableActionAuthorizer).authorize(any(HttpServletRequest.class), eq(MANAGE_EXPRESSION_FILTERS));
   }

   @Test
   public void getMalwareAttachmentStateHistory_NoHistoryFoundException() throws Exception {
      String errorMsg = UUID.randomUUID().toString();
      when(scanStateService.getMalwareAttachmentStatesHistory(errorMsg)).thenThrow(new MalwareScanFileNotFoundException(errorMsg));

      mockMvc.perform(get("/api/v1/attachments/malware-scan/states/history/{fileId}", errorMsg))
              .andExpect(status().isNotFound())
              .andExpect(header().string("Content-Type", "application/json;charset=UTF-8"))
              .andExpect(content().json("{\"message\":\"" + errorMsg + "\"}"))
              .andDo(document("get attachment malware states history - no history found",
                      preprocessRequest(prettyPrint()),
                      preprocessResponse(prettyPrint()),
                      pathParameters(
                              parameterWithName("fileId").description("Id of the file for which malware scan history will be retrieved")
                      ),
                      responseFields(
                              fieldWithPath("message").description("Message with details on an error")
                      ))
              );

      verify(scanStateService).getMalwareAttachmentStatesHistory(errorMsg);
      verify(entitleableActionAuthorizer).authorize(any(HttpServletRequest.class), eq(MANAGE_EXPRESSION_FILTERS));
   }

   @Test
   public void getMalwareAttachmentStateHistory_UnexpectedError() throws Exception {
      String fileId = "1";
      String errorMsg = UUID.randomUUID().toString();

      when(scanStateService.getMalwareAttachmentStatesHistory(fileId)).thenThrow(new RuntimeException(errorMsg));

      mockMvc.perform(get("/api/v1/attachments/malware-scan/states/history/{fileId}", fileId))
              .andExpect(status().isInternalServerError())
              .andExpect(header().string("Content-Type", "application/json;charset=UTF-8"))
              .andExpect(content().json("{\"message\":\"" + errorMsg + "\"}"))
              .andDo(document("get attachment malware states history - unexpected error",
                      preprocessRequest(prettyPrint()),
                      preprocessResponse(prettyPrint()),
                      pathParameters(
                              parameterWithName("fileId").description("Id of the file for which malware scan history will be retrieved")
                      ),
                      responseFields(
                              fieldWithPath("message").description("Message with details on an error")
                      ))
              );

      verify(scanStateService).getMalwareAttachmentStatesHistory(fileId);
      verify(entitleableActionAuthorizer).authorize(any(HttpServletRequest.class), eq(MANAGE_EXPRESSION_FILTERS));
   }

   @After
   public void after() {
      verifyNoMoreInteractions(scanStateService, entitleableActionAuthorizer);
   }

}