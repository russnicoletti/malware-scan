package com.symphony.malware.scan.controller;

import com.epages.restdocs.apispec.MockMvcRestDocumentationWrapper;
import com.epages.restdocs.apispec.ResourceSnippetParameters;
import com.symphony.exceptions.service.ForbiddenRequestException;
import com.symphony.malware.scan.exception.MalwareScanFileNotFoundException;
import com.symphony.malware.scan.model.MessageDetailsDto;
import com.symphony.malware.scan.model.FileInfoDto;
import com.symphony.malware.scan.model.MalwareScanFileStateDto;
import com.symphony.malware.scan.model.MalwareScanFileStatesHistoryDto;
import com.symphony.malware.scan.service.EntitleableActionAuthorizer;
import com.symphony.malware.scan.service.MalwareScanStateService;
import org.junit.After;
import org.junit.Before;
import org.junit.Rule;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.MockitoJUnitRunner;
import org.springframework.restdocs.JUnitRestDocumentation;
import org.springframework.test.web.servlet.MockMvc;
import org.springframework.test.web.servlet.setup.MockMvcBuilders;

import javax.servlet.http.HttpServletRequest;
import java.time.Instant;
import java.util.ArrayList;
import java.util.List;
import java.util.UUID;

import static com.epages.restdocs.apispec.MockMvcRestDocumentationWrapper.document;
import static com.epages.restdocs.apispec.ResourceDocumentation.resource;
import static com.symphony.data.common.roles.entitlableactions.EntitleableActionID.MANAGE_EXPRESSION_FILTERS;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.eq;
import static org.mockito.Mockito.doThrow;
import static org.mockito.Mockito.verify;
import static org.mockito.Mockito.verifyNoMoreInteractions;
import static org.mockito.Mockito.when;
import static org.springframework.restdocs.mockmvc.MockMvcRestDocumentation.documentationConfiguration;
import static org.springframework.restdocs.mockmvc.RestDocumentationRequestBuilders.get;
import static org.springframework.restdocs.operation.preprocess.Preprocessors.preprocessRequest;
import static org.springframework.restdocs.operation.preprocess.Preprocessors.preprocessResponse;
import static org.springframework.restdocs.operation.preprocess.Preprocessors.prettyPrint;
import static org.springframework.restdocs.payload.PayloadDocumentation.fieldWithPath;
import static org.springframework.restdocs.payload.PayloadDocumentation.subsectionWithPath;
import static org.springframework.restdocs.request.RequestDocumentation.parameterWithName;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.content;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.header;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;

/**
 * @author anton.g
 */
@RunWith(MockitoJUnitRunner.class)
public class MalwareScanStateControllerTest {

   @Mock
   private MalwareScanStateService scanStateService;

   @Mock
   private EntitleableActionAuthorizer entitleableActionAuthorizer;

   @InjectMocks
   private MalwareScanStateController controller;

   private MockMvc mockMvc;

   @Rule
   public JUnitRestDocumentation restDocumentation = new JUnitRestDocumentation();

   @Before
   public void setup() {
      mockMvc = MockMvcBuilders
              .standaloneSetup(controller)
              .setControllerAdvice(new MalwareScanStateControllerAdvice())
              .apply(documentationConfiguration(this.restDocumentation))
              .build();
   }

   @Test
   public void getMalwareAttachmentStateHistory_Success() throws Exception {
      // ARRANGE
      String fileId = "1";

      List<MalwareScanFileStateDto> scanStates = new ArrayList<>();
      String filename = UUID.randomUUID().toString();
      long fileSize = 123L;
      long timestamp = Instant.now().toEpochMilli();
      String scanningState = "OK";

      scanStates.add(new MalwareScanFileStateDto(scanningState, timestamp, MalwareScanFileStateDto.Source.SYMPHONY));
      long timestamp1 = Instant.now().toEpochMilli();
      String scanningState1 = "BAD";

      scanStates.add(new MalwareScanFileStateDto(scanningState1, timestamp1, MalwareScanFileStateDto.Source.CUSTOMER));

      List<MessageDetailsDto> messageDetails = new ArrayList<>();
      String streamId = UUID.randomUUID().toString();
      String streamName = UUID.randomUUID().toString();
      String streamType = UUID.randomUUID().toString();
      String messageId = UUID.randomUUID().toString();
      String sender = "test@mail.com";
      messageDetails.add(new MessageDetailsDto(streamId, streamName, streamType, messageId, sender));

      String streamId1 = UUID.randomUUID().toString();
      String streamName1 = UUID.randomUUID().toString();
      String streamType1 = UUID.randomUUID().toString();
      String messageId1 = UUID.randomUUID().toString();
      String sender1 = "another-test@mail.com";
      messageDetails.add(new MessageDetailsDto(streamId1, streamName1, streamType1, messageId1, sender1));

      FileInfoDto fileInfo = new FileInfoDto(filename, fileId, fileSize);

      MalwareScanFileStatesHistoryDto malwareScanStatesHistory = new MalwareScanFileStatesHistoryDto(fileInfo, scanStates, messageDetails);
      when(scanStateService.getMalwareAttachmentStatesHistory(fileId)).thenReturn(malwareScanStatesHistory);

      // ACT
      mockMvc.perform(
              get("/api/v1/attachments/malware-scan/states/history/{fileId}", fileId))
              // ASSERT
              .andExpect(status().isOk())
              .andExpect(header().string("Content-Type", "application/json;charset=UTF-8"))
              .andExpect(content().json("{\n" +
                      "    \"fileInfo\": {\n" +
                      "        \"fileName\": \"" + filename + "\",\n" +
                      "        \"fileId\":\"" + fileId + "\",\n" +
                      "        \"fileSize\":" + fileSize + "\n" +
                      "    },\n" +
                      "    \"scanStates\":[\n" +
                      "    {\n" +
                      "        \"scanningState\":\"" + scanningState + "\",\n" +
                      "        \"timestamp\":" + timestamp + ",\n" +
                      "        \"source\": \"Symphony\"\n" +
                      "    },\n" +
                      "    {\n" +
                      "        \"scanningState\":\"" + scanningState1 + "\",\n" +
                      "        \"timestamp\":" + timestamp1 + ",\n" +
                      "        \"source\": \"Customer\"\n" +
                      "    }\n" +
                      "  ],\n" +
                      "    \"conversationDetails\":[\n" +
                      "    {\n" +
                      "        \"streamId\" : \"" + streamId + "\",\n" +
                      "        \"streamName\" : \"" + streamName + "\",\n" +
                      "        \"streamType\" : \"" + streamType + "\",\n" +
                      "        \"sender\":   \"" + sender + "\",\n" +
                      "        \"messageId\" : \"" + messageId + "\"\n" +
                      "    },\n" +
                      "    {\n" +
                      "        \"streamId\" : \"" + streamId1 + "\",\n" +
                      "        \"streamName\" : \"" + streamName1 + "\",\n" +
                      "        \"streamType\" : \"" + streamType1 + "\",\n" +
                      "        \"sender\":   \"" + sender1 + "\",\n" +
                      "        \"messageId\" : \"" + messageId1 + "\"\n" +
                      "    }\n" +
                      "   ]\n" +
                      "}"))
              .andDo(document("get-file-malware-status-history",
                      MockMvcRestDocumentationWrapper
                              .resourceDetails(),
                      preprocessRequest(prettyPrint()),
                      preprocessResponse(prettyPrint()),
                      resource(ResourceSnippetParameters.builder()
                              .description("Retrieves history of malware scan statuses of a file")
                              .pathParameters(
                                      parameterWithName("fileId").description("Id of the file for which malware scan history will be retrieved"))
                              .responseFields(
                                      subsectionWithPath("fileInfo").description("Metadata of a file"),
                                      fieldWithPath("fileInfo.fileName").description("Name of the file"),
                                      fieldWithPath("fileInfo.fileId").description("Id of the file"),
                                      fieldWithPath("fileInfo.fileSize").description("Size of the file in bytes"),

                                      subsectionWithPath("scanStates").description("History of malware states of a file"),
                                      fieldWithPath("scanStates[].scanningState").description("Malware scan state value"),
                                      fieldWithPath("scanStates[].timestamp").description("Timestamp which denotes when this status was received from malware scanner"),
                                      fieldWithPath("scanStates[].source").description("Source of the status. Either Symproxy or Customer"),

                                      subsectionWithPath("conversationDetails").description("Details on a conversation where this file appeared"),
                                      fieldWithPath("conversationDetails[].streamId").description("Id of the stream where this file appeared"),
                                      fieldWithPath("conversationDetails[].streamName").description("Name of the stream where this file appeared"),
                                      fieldWithPath("conversationDetails[].streamType").description("Type of the stream where this file appeared"),
                                      fieldWithPath("conversationDetails[].sender").description("Email of a user sent this message"),
                                      fieldWithPath("conversationDetails[].messageId").description("Id of the message which contains this file")
                              ).build()
                      ))
              );

      verify(scanStateService).getMalwareAttachmentStatesHistory(fileId);
      verify(entitleableActionAuthorizer).authorize(any(HttpServletRequest.class), eq(MANAGE_EXPRESSION_FILTERS));
   }

   @Test
   public void getMalwareAttachmentStateHistory_EntitlementCheckFailure() throws Exception {
      String fileId = "1";
      doThrow(ForbiddenRequestException.class).when(entitleableActionAuthorizer).authorize(any(HttpServletRequest.class), eq(MANAGE_EXPRESSION_FILTERS));

      mockMvc.perform(get("/api/v1/attachments/malware-scan/states/history/{fileId}", fileId))
              .andExpect(status().isForbidden())
              .andExpect(header().string("Content-Type", "application/json;charset=UTF-8"))
              .andExpect(content().json("{\"message\":\"Not entitled to access resource: endpoint entitlement check failed\"}"))
              .andDo(document("get-file-malware-status-history-_-entitlement-check-error",
                      MockMvcRestDocumentationWrapper
                              .resourceDetails(),
                      preprocessRequest(prettyPrint()),
                      preprocessResponse(prettyPrint()),
                      resource(ResourceSnippetParameters.builder()
                              .description("Retrieves history of malware scan statuses of a file - entitlement error")
                              .pathParameters(
                                      parameterWithName("fileId").description("Id of the file for which malware scan history will be retrieved"))
                              .responseFields(
                                      fieldWithPath("message").description("Message with entitlement check error details")
                              ).build()))
              );

      verify(entitleableActionAuthorizer).authorize(any(HttpServletRequest.class), eq(MANAGE_EXPRESSION_FILTERS));
   }

   @Test
   public void getMalwareAttachmentStateHistory_NoHistoryFoundException() throws Exception {
      String errorMsg = UUID.randomUUID().toString();
      when(scanStateService.getMalwareAttachmentStatesHistory(errorMsg)).thenThrow(new MalwareScanFileNotFoundException(errorMsg));

      mockMvc.perform(get("/api/v1/attachments/malware-scan/states/history/{fileId}", errorMsg))
              .andExpect(status().isNotFound())
              .andExpect(header().string("Content-Type", "application/json;charset=UTF-8"))
              .andExpect(content().json("{\"message\":\"" + errorMsg + "\"}"))
              .andDo(document("get-file-malware-status-history-_-no-states-history-found",
                      MockMvcRestDocumentationWrapper
                              .resourceDetails(),
                      preprocessRequest(prettyPrint()),
                      preprocessResponse(prettyPrint()),
                      resource(ResourceSnippetParameters.builder()
                              .description("Retrieves history of malware scan statuses of a file - No malware states history found for a file")
                              .pathParameters(
                                      parameterWithName("fileId").description("Id of the file for which malware scan history will be retrieved"))
                              .responseFields(
                                      fieldWithPath("message").description("Message with details on an error")
                              ).build()))
              );

      verify(scanStateService).getMalwareAttachmentStatesHistory(errorMsg);
      verify(entitleableActionAuthorizer).authorize(any(HttpServletRequest.class), eq(MANAGE_EXPRESSION_FILTERS));
   }

   @Test
   public void getMalwareAttachmentStateHistory_UnexpectedError() throws Exception {
      String fileId = "1";
      String errorMsg = UUID.randomUUID().toString();

      when(scanStateService.getMalwareAttachmentStatesHistory(fileId)).thenThrow(new RuntimeException(errorMsg));

      mockMvc.perform(get("/api/v1/attachments/malware-scan/states/history/{fileId}", fileId))
              .andExpect(status().isInternalServerError())
              .andExpect(header().string("Content-Type", "application/json;charset=UTF-8"))
              .andExpect(content().json("{\"message\":\"" + errorMsg + "\"}"))
              .andDo(document("get-file-malware-status-history-_-unexpected-error",
                      MockMvcRestDocumentationWrapper
                              .resourceDetails(),
                      preprocessRequest(prettyPrint()),
                      preprocessResponse(prettyPrint()),
                      resource(ResourceSnippetParameters.builder()
                              .description("Retrieves history of malware scan statuses of a file - Unexpected error happens during history retrieval process")
                              .pathParameters(
                                      parameterWithName("fileId").description("Id of the file for which malware scan history will be retrieved"))
                              .responseFields(
                                      fieldWithPath("message").description("Message with details on an error")
                              ).build()))
              );

      verify(scanStateService).getMalwareAttachmentStatesHistory(fileId);
      verify(entitleableActionAuthorizer).authorize(any(HttpServletRequest.class), eq(MANAGE_EXPRESSION_FILTERS));
   }

   @After
   public void after() {
      verifyNoMoreInteractions(scanStateService, entitleableActionAuthorizer);
   }

}