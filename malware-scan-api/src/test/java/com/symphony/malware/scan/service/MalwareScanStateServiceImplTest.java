package com.symphony.malware.scan.service;

import com.symphony.clouds.api.storage.v1.FileMetaData;
import com.symphony.malware.scan.exception.MalwareScanFileNotFoundException;
import com.symphony.malware.scan.model.Actor;
import com.symphony.malware.scan.model.FileInfoDto;
import com.symphony.malware.scan.model.MalwareScanFileMapping;
import com.symphony.malware.scan.model.MalwareScanFileState;
import com.symphony.malware.scan.model.MalwareScanFileStateDto;
import com.symphony.malware.scan.model.MalwareScanFileStatesHistoryDto;
import com.symphony.malware.scan.model.MessageDetailsDto;
import com.symphony.malware.scan.model.Sender;
import com.symphony.malware.scan.persistence.service.MalwareScanPersistenceService;
import org.junit.After;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.MockitoJUnitRunner;

import java.time.Instant;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.Optional;
import java.util.UUID;

import static org.junit.Assert.assertEquals;
import static org.mockito.Mockito.verify;
import static org.mockito.Mockito.verifyNoMoreInteractions;
import static org.mockito.Mockito.when;

/**
 * @author anton.g
 */
@RunWith(MockitoJUnitRunner.class)
public class MalwareScanStateServiceImplTest {

   @Mock
   private MalwareScanPersistenceService malwareScanPersistenceService;

   @Mock
   private AttachmentFileService attachmentFileService;

   @InjectMocks
   private MalwareScanStateServiceImpl malwareScanStateService;

   @Test
   public void testGetMalwareScanStatesHistory_Success() throws Exception {
      // ARRANGE
      String fileId = UUID.randomUUID().toString();
      String fileName = UUID.randomUUID().toString();

      long sizeInBytes = 1234567L;

      // mocking malware states
      List<MalwareScanFileStateDto> expectedMalwareScanFileStates = new ArrayList<>();
      List<MalwareScanFileState> fileStates = new ArrayList<>();

      String messageId = UUID.randomUUID().toString();
      MalwareScanFileState.Status status = MalwareScanFileState.Status.OK;
      Instant createTimestamp = Instant.now();
      Actor lastUpdatedBy = Actor.SYMPHONY;

      MalwareScanFileState fileState = createMalwareScanFileState(fileId, messageId, status, createTimestamp, lastUpdatedBy);
      fileStates.add(fileState);

      expectedMalwareScanFileStates.add(new MalwareScanFileStateDto(status.toString(), createTimestamp.toEpochMilli(), MalwareScanFileStateDto.Source.SYMPHONY));

      String messageId1 = UUID.randomUUID().toString();
      MalwareScanFileState.Status status1 = MalwareScanFileState.Status.BAD;
      Instant createTimestamp1 = Instant.now();
      Actor lastUpdatedBy1 = Actor.MALWARE_SCANNER;

      MalwareScanFileState fileState1 = createMalwareScanFileState(fileId, messageId1, status1, createTimestamp1, lastUpdatedBy1);
      fileStates.add(fileState1);

      expectedMalwareScanFileStates.add(new MalwareScanFileStateDto(status1.toString(), createTimestamp1.toEpochMilli(), MalwareScanFileStateDto.Source.CUSTOMER));

      when(malwareScanPersistenceService.getMalwareScanFileStates(fileId)).thenReturn(fileStates);

      // mocking file metadata
      FileMetaData fileMetaData = new FileMetaData(123L, sizeInBytes, "TYPE", true);
      fileMetaData.setName(fileName);
      fileMetaData.setFileId(fileId);
      when(attachmentFileService.getFileMetadata(fileId)).thenReturn(Optional.of(fileMetaData));

      // mocking malware scan file mappings
      List<MalwareScanFileMapping> scanFileMappings = new ArrayList<>();
      List<MessageDetailsDto> expectedConversationDetails = new ArrayList<>();

      String senderEmail = "test@mail.com";
      String streamId = UUID.randomUUID().toString();
      String streamName = UUID.randomUUID().toString();
      String streamType = UUID.randomUUID().toString();

      MalwareScanFileMapping scanFileMapping = createMalwareScanFileMapping(fileId, messageId, senderEmail, streamId, streamName, streamType);
      expectedConversationDetails.add(new MessageDetailsDto(streamId, streamName, streamType, messageId, senderEmail));

      String senderEmail1 = "test1@mail.com";
      String streamId1 = UUID.randomUUID().toString();
      String streamName1 = UUID.randomUUID().toString();
      String streamType1 = UUID.randomUUID().toString();

      MalwareScanFileMapping scanFileMapping1 = createMalwareScanFileMapping(fileId, messageId1, senderEmail1, streamId1, streamName1, streamType1);
      expectedConversationDetails.add(new MessageDetailsDto(streamId1, streamName1, streamType1, messageId1, senderEmail1));

      String senderEmail2 = "test2@mail.com";
      String streamId2 = UUID.randomUUID().toString();
      String messageId2 = UUID.randomUUID().toString();
      String streamName2 = UUID.randomUUID().toString();
      String streamType2 = UUID.randomUUID().toString();
      MalwareScanFileMapping scanFileMapping2 = createMalwareScanFileMapping(fileId, messageId2, senderEmail2, streamId2, streamName2, streamType2);
      expectedConversationDetails.add(new MessageDetailsDto(streamId2, streamName2, streamType2, messageId2, senderEmail2));

      scanFileMappings.add(scanFileMapping);
      scanFileMappings.add(scanFileMapping1);
      scanFileMappings.add(scanFileMapping2);

      FileInfoDto fileInfo = new FileInfoDto(fileName, fileId, sizeInBytes);

      when(malwareScanPersistenceService.getMalwareScanFileMappings(fileId)).thenReturn(scanFileMappings);

      MalwareScanFileStatesHistoryDto expectedHistory = new MalwareScanFileStatesHistoryDto(fileInfo, expectedMalwareScanFileStates, expectedConversationDetails);

      // ACT
      MalwareScanFileStatesHistoryDto actualHistory = malwareScanStateService.getMalwareAttachmentStatesHistory(fileId);

      // ASSERT
      assertEquals(expectedHistory, actualHistory);

      verify(malwareScanPersistenceService).getMalwareScanFileMappings(fileId);
      verify(malwareScanPersistenceService).getMalwareScanFileStates(fileId);
   }

   @Test(expected = MalwareScanFileNotFoundException.class)
   public void testGetMalwareScanStatesHistory_FileMetadataNotFound() throws Exception {
      // ARRANGE
      String fileId = UUID.randomUUID().toString();

      // mocking malware states
      List<MalwareScanFileState> fileStates = new ArrayList<>();

      String messageId = UUID.randomUUID().toString();
      MalwareScanFileState.Status status = MalwareScanFileState.Status.OK;
      Instant createTimestamp = Instant.now();
      Actor lastUpdatedBy = Actor.SYMPHONY;

      MalwareScanFileState fileState = createMalwareScanFileState(fileId, messageId, status, createTimestamp, lastUpdatedBy);
      fileStates.add(fileState);

      String messageId1 = UUID.randomUUID().toString();
      MalwareScanFileState.Status status1 = MalwareScanFileState.Status.BAD;
      Instant createTimestamp1 = Instant.now();
      Actor lastUpdatedBy1 = Actor.MALWARE_SCANNER;

      MalwareScanFileState fileState1 = createMalwareScanFileState(fileId, messageId1, status1, createTimestamp1, lastUpdatedBy1);
      fileStates.add(fileState1);

      when(malwareScanPersistenceService.getMalwareScanFileStates(fileId)).thenReturn(fileStates);

      when(attachmentFileService.getFileMetadata(fileId)).thenReturn(Optional.empty());

      // mocking malware scan file mappings
      List<MalwareScanFileMapping> scanFileMappings = new ArrayList<>();

      MalwareScanFileMapping scanFileMapping = createMalwareScanFileMapping(fileId, messageId, "test@mail.com", UUID.randomUUID().toString(), UUID.randomUUID().toString(), UUID.randomUUID().toString());

      scanFileMappings.add(scanFileMapping);

      when(malwareScanPersistenceService.getMalwareScanFileMappings(fileId)).thenReturn(scanFileMappings);

      // ACT
      try {
         malwareScanStateService.getMalwareAttachmentStatesHistory(fileId);
      } finally {
         // ASSERT
         verify(malwareScanPersistenceService).getMalwareScanFileMappings(fileId);
         verify(malwareScanPersistenceService).getMalwareScanFileStates(fileId);
      }
   }

   @Test(expected = MalwareScanFileNotFoundException.class)
   public void testGetMalwareScanStatesHistory_NoMalwareScanFileMappingFound() throws Exception {
      // ARRANGE
      String fileId = UUID.randomUUID().toString();

      // mocking malware states
      List<MalwareScanFileState> fileStates = new ArrayList<>();

      String messageId = UUID.randomUUID().toString();
      MalwareScanFileState.Status status = MalwareScanFileState.Status.OK;
      Instant createTimestamp = Instant.now();
      Actor lastUpdatedBy = Actor.SYMPHONY;

      MalwareScanFileState fileState = createMalwareScanFileState(fileId, messageId, status, createTimestamp, lastUpdatedBy);
      fileStates.add(fileState);

      when(malwareScanPersistenceService.getMalwareScanFileStates(fileId)).thenReturn(fileStates);
      when(malwareScanPersistenceService.getMalwareScanFileMappings(fileId)).thenReturn(Collections.emptyList());

      try {
         // ACT
         malwareScanStateService.getMalwareAttachmentStatesHistory(fileId);
      } finally {
         // ASSERT
         verify(malwareScanPersistenceService).getMalwareScanFileStates(fileId);
         verify(malwareScanPersistenceService).getMalwareScanFileMappings(fileId);
      }
   }

   @Test(expected = MalwareScanFileNotFoundException.class)
   public void testGetMalwareScanStatesHistory_NoStateHistoryFound() throws Exception {
      // ARRANGE
      String fileId = UUID.randomUUID().toString();

      when(malwareScanPersistenceService.getMalwareScanFileStates(fileId)).thenReturn(Collections.emptyList());

      try {
         // ACT
         malwareScanStateService.getMalwareAttachmentStatesHistory(fileId);
      } finally {
         // ASSERT
         verify(malwareScanPersistenceService).getMalwareScanFileStates(fileId);
      }
   }

   @After
   public void after() {
      verifyNoMoreInteractions(malwareScanPersistenceService);
   }

   private MalwareScanFileMapping createMalwareScanFileMapping(String fileId, String messageId, String senderEmail, String streamId, String streamName, String streamType) {
      return MalwareScanFileMapping
              .builder()
              .fileId(fileId)
              .messageId(messageId)
              .streamId(streamId)
              .streamName(streamName)
              .streamType(streamType)
              .sender(Sender.builder().email(senderEmail).build())
              .build();
   }

   private MalwareScanFileState createMalwareScanFileState(String fileId, String messageId, MalwareScanFileState.Status status, Instant createTimestamp, Actor lastUpdatedBy) {
      return MalwareScanFileState
              .builder()
              .fileId(fileId)
              .status(status)
              .createTimestamp(createTimestamp)
              .lastUpdatedBy(lastUpdatedBy)
              .originalMessageId(messageId)
              .build();
   }

}