package com.symphony.malware.scan.service;

import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.Matchers.any;
import static org.mockito.Matchers.eq;
import static org.mockito.Mockito.doThrow;
import static org.mockito.Mockito.times;
import static org.mockito.Mockito.verify;
import static org.mockito.Mockito.when;

import com.symphony.data.mapper.PersistentException;
import com.symphony.malware.scan.Status;
import com.symphony.malware.scan.model.Actor;
import com.symphony.malware.scan.model.AttachmentMetaDto;
import com.symphony.malware.scan.model.MalwareScanFileMapping;
import com.symphony.malware.scan.model.MalwareScanFileState;
import com.symphony.malware.scan.model.MalwareScanRequestDto;
import com.symphony.malware.scan.model.MalwareScanResponseDto;
import com.symphony.malware.scan.persistence.exception.MalwareScanException;
import com.symphony.malware.scan.persistence.service.MalwareScanPersistenceService;

import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.Mock;
import org.mockito.runners.MockitoJUnitRunner;

import java.util.Optional;

@RunWith(MockitoJUnitRunner.class)
public class MalwareScanOperationPersistenceServiceTest {

    private static final String FILE_ID = "fileId";
    private static final Integer FROM_POD = 21;

    @Mock
    private MalwareScanPersistenceService malwareScanPersistenceService;

    private MalwareScanOperationPersistenceService malwareScanOperationPersistenceService;

    @Before
    public void before() {
        this.malwareScanOperationPersistenceService = new MalwareScanOperationPersistenceService(malwareScanPersistenceService);
    }

    @Test
    public void create_persistentException_failed() throws Exception {
        doThrow(PersistentException.class).when(malwareScanPersistenceService).putMalwareScanFileMapping(any(MalwareScanFileMapping.class));

        final MalwareScanResponseDto malwareScanResponseDto = malwareScanOperationPersistenceService.create(
            MalwareScanRequestDto.builder().fromPod(FROM_POD).attachmentMetaDto(AttachmentMetaDto.builder().build()).build(),
            MalwareScanFileState.Status.PENDING, Actor.SYMPHONY);

        assertThat(malwareScanResponseDto.getStatus()).isEqualTo(Status.FAILED);
        assertThat(malwareScanResponseDto.getError()).contains("Failed to create malware scan information");

        verify(malwareScanPersistenceService, times(0)).putMalwareScanFileState(any(MalwareScanFileState.class), any(Actor.class));
    }

    @Test
    public void create_malwareScanUpdateException_failed() throws Exception {
        doThrow(MalwareScanException.class).when(malwareScanPersistenceService).putMalwareScanFileState(any(MalwareScanFileState.class), any(Actor.class));

        final MalwareScanResponseDto malwareScanResponseDto = malwareScanOperationPersistenceService.create(
            MalwareScanRequestDto.builder().fromPod(FROM_POD).attachmentMetaDto(AttachmentMetaDto.builder().build()).build(),
            MalwareScanFileState.Status.PENDING, Actor.SYMPHONY);

        assertThat(malwareScanResponseDto.getStatus()).isEqualTo(Status.FAILED);
        assertThat(malwareScanResponseDto.getError()).contains("Failed to create malware scan information");

        verify(malwareScanPersistenceService, times(1)).putMalwareScanFileMapping(any(MalwareScanFileMapping.class));
    }

    @Test
    public void create_noException_ok() throws Exception {
        final MalwareScanResponseDto malwareScanResponseDto = malwareScanOperationPersistenceService.create(
            MalwareScanRequestDto.builder().fromPod(FROM_POD).attachmentMetaDto(AttachmentMetaDto.builder().build()).build(),
            MalwareScanFileState.Status.PENDING, Actor.SYMPHONY);

        assertThat(malwareScanResponseDto.getStatus()).isEqualTo(Status.OK);
        assertThat(malwareScanResponseDto.getError()).contains("");

        verify(malwareScanPersistenceService, times(1)).putMalwareScanFileMapping(any(MalwareScanFileMapping.class));
        verify(malwareScanPersistenceService, times(1)).putMalwareScanFileState(any(MalwareScanFileState.class), eq(Actor.SYMPHONY));
    }

    @Test
    public void update_persistentException_failed() throws Exception {
        when(malwareScanPersistenceService.getMalwareScanFileState(FILE_ID)).thenReturn(Optional.of(MalwareScanFileState.builder().build()));
        doThrow(PersistentException.class).when(malwareScanPersistenceService).putMalwareScanFileState(any(MalwareScanFileState.class), any(Actor.class));

        final MalwareScanResponseDto malwareScanResponseDto = malwareScanOperationPersistenceService.update(
            MalwareScanRequestDto.builder().attachmentMetaDto(AttachmentMetaDto.builder().fileId(FILE_ID).build()).build(),
            MalwareScanFileState.Status.SUBMITTED, Actor.SYMPHONY);

        assertThat(malwareScanResponseDto.getStatus()).isEqualTo(Status.FAILED);
        assertThat(malwareScanResponseDto.getError()).contains("Failed to update malware scan information");
    }

    @Test
    public void update_malwareScanUpdateException_failed() throws Exception {
        when(malwareScanPersistenceService.getMalwareScanFileState(FILE_ID)).thenReturn(Optional.of(MalwareScanFileState.builder().build()));
        doThrow(MalwareScanException.class).when(malwareScanPersistenceService).putMalwareScanFileState(any(MalwareScanFileState.class), any(Actor.class));

        final MalwareScanResponseDto malwareScanResponseDto = malwareScanOperationPersistenceService.update(
            MalwareScanRequestDto.builder().attachmentMetaDto(AttachmentMetaDto.builder().fileId(FILE_ID).build()).build(),
            MalwareScanFileState.Status.SUBMITTED, Actor.SYMPHONY);

        assertThat(malwareScanResponseDto.getStatus()).isEqualTo(Status.FAILED);
        assertThat(malwareScanResponseDto.getError()).contains("Failed to update malware scan information");
    }

    @Test
    public void update_existingMalwareScanFileStateNotFound_failed() throws Exception {
        when(malwareScanPersistenceService.getMalwareScanFileState(FILE_ID)).thenReturn(Optional.empty());

        final MalwareScanResponseDto malwareScanResponseDto = malwareScanOperationPersistenceService.update(
            MalwareScanRequestDto.builder().attachmentMetaDto(AttachmentMetaDto.builder().fileId(FILE_ID).build()).build(),
            MalwareScanFileState.Status.SUBMITTED, Actor.SYMPHONY);

        assertThat(malwareScanResponseDto.getStatus()).isEqualTo(Status.FAILED);
        assertThat(malwareScanResponseDto.getError()).contains("Failed to update malware scan information");

        verify(malwareScanPersistenceService, times(0)).putMalwareScanFileState(any(MalwareScanFileState.class), any(Actor.class));
    }

    @Test
    public void update_noException_ok() throws Exception {
        when(malwareScanPersistenceService.getMalwareScanFileState(FILE_ID)).thenReturn(Optional.of(MalwareScanFileState.builder().build()));

        final MalwareScanResponseDto malwareScanResponseDto = malwareScanOperationPersistenceService.update(
            MalwareScanRequestDto.builder().attachmentMetaDto(AttachmentMetaDto.builder().fileId(FILE_ID).build()).build(),
            MalwareScanFileState.Status.SUBMITTED, Actor.SYMPHONY);

        assertThat(malwareScanResponseDto.getStatus()).isEqualTo(Status.OK);
        assertThat(malwareScanResponseDto.getError()).contains("");

        verify(malwareScanPersistenceService, times(1)).putMalwareScanFileState(any(MalwareScanFileState.class), eq(Actor.SYMPHONY));
    }

}
