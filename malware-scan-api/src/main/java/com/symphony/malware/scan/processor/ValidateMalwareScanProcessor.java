package com.symphony.malware.scan.processor;

import com.symphony.malware.scan.Status;
import com.symphony.malware.scan.model.MalwareScanRequestDto;
import com.symphony.malware.scan.model.MalwareScanResponseDto;
import com.symphony.malware.scan.service.MalwareScanValidationService;

import lombok.extern.slf4j.Slf4j;

@Slf4j
public class ValidateMalwareScanProcessor extends MalwareScanProcessor {

    private final MalwareScanValidationService malwareScanValidationService;

    public ValidateMalwareScanProcessor(
        final MalwareScanValidationService malwareScanValidationService

    ) {
        this.malwareScanValidationService = malwareScanValidationService;
    }

    @Override
    public MalwareScanResponseDto process(final MalwareScanRequestDto malwareScanRequestDto) {
        final MalwareScanResponseDto malwareScanResponseDto = malwareScanValidationService.validate(malwareScanRequestDto)
            .toBuilder().malwareScanRequestDto(malwareScanRequestDto).build();

        if (Status.OK.equals(malwareScanResponseDto.getStatus())) {
            return getNext(malwareScanResponseDto).process(malwareScanRequestDto);
        } else {
            LOGGER.error("Error encountered while validating malware scan request {}", malwareScanRequestDto);
            // TODO Throw here an exception, but make sure it is handled in SBE and message is replayed
            // TODO Should be done in sope of https://perzoinc.atlassian.net/browse/DLP-4406
            return malwareScanResponseDto;
        }
    }

}
