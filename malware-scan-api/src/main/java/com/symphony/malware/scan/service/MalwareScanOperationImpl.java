package com.symphony.malware.scan.service;

import static com.symphony.malware.scan.Status.FAILED;
import static com.symphony.malware.scan.Status.OK;

import com.symphony.container.connector.ConnectionIdUsageScenario;
import com.symphony.container.connector.ContainerConnector;
import com.symphony.container.connector.ContainerRpcController;
import com.symphony.container.connector.GenericRLPBlockingRpcChanel;
import com.symphony.container.connector.config.ConnectionRequestType;
import com.symphony.container.connector.config.ContainerConnectorConfiguration;
import com.symphony.container.connector.metric.SymproxMetricReportCache;
import com.symphony.malware.scan.AttachmentData;
import com.symphony.malware.scan.MalwareScanRequest;
import com.symphony.malware.scan.MalwareScanResponse;
import com.symphony.malware.scan.MalwareScanService;
import com.symphony.malware.scan.model.Attachment;
import com.symphony.malware.scan.model.MalwareScanRequestDTO;
import com.symphony.proto320.BlockingRpcChannel;
import com.symphony.proto320.ServiceException;
import com.symphony.remoteservice.longpoll.client.RLPUsageScenario;

import com.google.common.base.Optional;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.ArrayList;
import java.util.List;

/**
 * Malware scanning operations
 */
public class MalwareScanOperationImpl implements MalwareScanOperation {
  private static final Logger LOGGER = LoggerFactory.getLogger(MalwareScanOperationImpl.class);

  private final ContainerConnector connector;
  private final SymproxMetricReportCache metricReportCache;
  private final ContainerConnectorConfiguration connectorConfiguration;

  public MalwareScanOperationImpl(
      ContainerConnector connector,
      SymproxMetricReportCache metricReportCache,
      ContainerConnectorConfiguration connectorConfiguration
  ) {
    this.connector = connector;
    this.metricReportCache = metricReportCache;
    this.connectorConfiguration = connectorConfiguration;
  }

  /**
   * Builds and sends a request to symproxy for malware scanning for each attachment respectively
   * @param malwareScanDTO
   * @return List<MalwareScanResponse>
   */
  @Override
  public List<MalwareScanResponse> scan(MalwareScanRequestDTO malwareScanDTO) {
    MalwareScanRequest malwareRQ = getMalwareScanRequest(malwareScanDTO);
    List<MalwareScanResponse> malwareScanRespons = new ArrayList<>();
    for (Attachment attachment : malwareScanDTO.getAttachments()) {
      AttachmentData.AttachmentMeta attachmentMeta = getAttachmentMeta(attachment);
      MalwareScanResponse response = sendReq(malwareRQ, attachmentMeta);
      //TODO save malware scanned entity per attachment to database
      malwareScanRespons.add(response);
    }
    return malwareScanRespons;
  }

  /**
   * Sends a request per attachment in social message
   * @param malwareRQ, attachmentMeta
   * @return List<MalwareScanResponse>
   */
  private MalwareScanResponse sendReq(MalwareScanRequest malwareRQ,
      AttachmentData.AttachmentMeta attachmentMeta) {
    MalwareScanResponse response;
    malwareRQ = malwareRQ.toBuilder().setAttachmentMeta(attachmentMeta).build();
    try {
      LOGGER.info("Sending request for malware scanning: " + malwareRQ);
      response = sendRLPRequest(malwareRQ);
      response = response.toBuilder().setStatus(OK).build();
    } catch (ServiceException e) {
      response = MalwareScanResponse.newBuilder()
          .setStatus(FAILED)
          .setError(e.getLocalizedMessage())
          .build();
      String errMsg = String.format(
          "Failed to send the attachment %s for MalWare scanning with stream id %s",
          malwareRQ.getAttachmentMeta(),
          malwareRQ.getStreamId());
      LOGGER.error(errMsg, e);
    }
    LOGGER.info("Got response from malware scanning: " + response);
    return response;
  }

  /**
   * Creates a message level context for each attachment in a message
   * @param malwareScanDTO
   * @return MalwareScanRequest
   */
  private MalwareScanRequest getMalwareScanRequest(MalwareScanRequestDTO malwareScanDTO) {
    MalwareScanRequest.Builder malwareRequest = MalwareScanRequest.newBuilder();
    malwareRequest.setMessageId(malwareScanDTO.getUniqueMessageId());
    malwareRequest.setCreationTime(malwareScanDTO.getActualIngestionDate());
    malwareRequest.setStreamId(malwareScanDTO.getThreadId());
    return malwareRequest.build();
  }

  /**
   * Creates an attachment meta
   * @param attachment
   * @return Sender
   */
  private AttachmentData.AttachmentMeta getAttachmentMeta(Attachment attachment) {
    return AttachmentData.AttachmentMeta.newBuilder()
        .setName(attachment.getName())
        .setFileId(attachment.getFileId())
        .setContentType(attachment.getContentType())
        .setCreatorId(attachment.getCreatorId())
        .setSizeInBytes(attachment.getSizeInBytes())
        .build();
  }

  /**
   * Sends a request to the random symproxy for malware scanning
   * @param request
   * @return
   * @throws ServiceException
   */
  private MalwareScanResponse sendRLPRequest(MalwareScanRequest request) throws ServiceException {
    // Create the rpc channel using specified connectionId
    final BlockingRpcChannel blockingRpcChannel = new GenericRLPBlockingRpcChanel(
        ConnectionIdUsageScenario.VALID, RLPUsageScenario.USE_RLP_SERVICE, connector, metricReportCache,
        Optional.absent(), Optional.absent(), connectorConfiguration, ConnectionRequestType.TEXT_ONLY);

    final MalwareScanService.BlockingInterface blockingInterface = MalwareScanService.newBlockingStub(blockingRpcChannel);
    return blockingInterface.performScanning(new ContainerRpcController(), request);
  }

}
