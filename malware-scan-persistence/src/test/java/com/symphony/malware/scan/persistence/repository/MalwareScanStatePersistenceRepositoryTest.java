package com.symphony.malware.scan.persistence.repository;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;
import static org.mockito.Matchers.any;
import static org.mockito.Matchers.eq;
import static org.mockito.Mockito.times;
import static org.mockito.Mockito.verify;
import static org.mockito.Mockito.when;

import com.symphony.data.infrastructure.IPersistenceInfra;
import com.symphony.data.mapper.IKeyValueTable;
import com.symphony.data.mapper.PersistentException;
import com.symphony.malware.scan.model.MalwareScanState;

import com.fasterxml.jackson.databind.JsonMappingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.apache.commons.lang3.CharEncoding;
import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.Mock;
import org.mockito.runners.MockitoJUnitRunner;

import java.io.Closeable;
import java.nio.charset.Charset;
import java.util.function.Supplier;

@RunWith(MockitoJUnitRunner.class)
public class MalwareScanStatePersistenceRepositoryTest {

  private static final Charset CHARSET = Charset.forName(CharEncoding.UTF_8);
  private static final String MALWARE_SCAN_STATE_TABLE = "malwareScanState";

  private static final String FILE_ID = "fileId0001";

  @Mock
  private IPersistenceInfra persistenceInfra;

  @Mock
  private Supplier<ObjectMapper> objectMapperSupplier;

  @Mock
  private ObjectMapper objectMapper;

  @Mock
  private IKeyValueTable malwareScanStateKeyValueTable;

  @Mock
  private Closeable closeable;

  @Before
  public void before() throws Exception {
    when(objectMapperSupplier.get()).thenReturn(objectMapper);
    when(persistenceInfra.getKeyValueTable(MALWARE_SCAN_STATE_TABLE)).thenReturn(malwareScanStateKeyValueTable);
  }

  @Test
  public void createRepository_malwareScanStateTableExists_createTableNotCalled() throws Exception {
    when(malwareScanStateKeyValueTable.exist()).thenReturn(Boolean.TRUE);

    new MalwareScanStatePersistenceRepository(persistenceInfra, objectMapperSupplier);

    verify(malwareScanStateKeyValueTable, times(0)).createTable();
  }

  @Test
  public void createRepository_malwareScanStateTableDoesNotExist_createTableCalled() throws Exception {
    when(malwareScanStateKeyValueTable.exist()).thenReturn(Boolean.FALSE);

    new MalwareScanStatePersistenceRepository(persistenceInfra, objectMapperSupplier);

    verify(malwareScanStateKeyValueTable, times(1)).createTable();
  }

  @Test
  public void save_noException_malwareScanStatePut() throws Exception {
    final MalwareScanState malwareScanState = MalwareScanState.builder().fileId(FILE_ID).build();

    when(objectMapper.writeValueAsString(malwareScanState)).thenReturn("{}");
    new MalwareScanStatePersistenceRepository(persistenceInfra, objectMapperSupplier).save(FILE_ID, malwareScanState);

    verify(objectMapper, times(1)).writeValueAsString(malwareScanState);
    verify(malwareScanStateKeyValueTable, times(1)).save(eq(FILE_ID.getBytes(CHARSET)), any(byte[].class));
  }

  @Test
  public void save_jsonProcessingException_persistentExceptionThrown() throws Exception {
    final MalwareScanState malwareScanState = MalwareScanState.builder().fileId(FILE_ID).build();

    when(objectMapper.writeValueAsString(malwareScanState)).thenThrow(new JsonMappingException(closeable, "JSON Mapping Exception"));

    assertThatThrownBy(() -> new MalwareScanStatePersistenceRepository(persistenceInfra, objectMapperSupplier)
        .save(FILE_ID, malwareScanState)).isInstanceOf(PersistentException.class)
        .hasMessage("com.fasterxml.jackson.databind.JsonMappingException: JSON Mapping Exception");

    verify(objectMapper, times(1)).writeValueAsString(any(MalwareScanState.class));
    verify(malwareScanStateKeyValueTable, times(0)).save(any(byte[].class), any(byte[].class));
  }

  @Test
  public void load_valueIsNotNull_malwareScanStateReturned() throws Exception {
    final MalwareScanState malwareScanState = MalwareScanState.builder().fileId(FILE_ID).build();
    final byte[] malwareScanStateBytes = ("{\"fileId\":\"" + FILE_ID + "\"}").getBytes(CHARSET);

    when(malwareScanStateKeyValueTable.load(FILE_ID.getBytes(CHARSET))).thenReturn(malwareScanStateBytes);
    when(objectMapper.readValue(malwareScanStateBytes, MalwareScanState.class)).thenReturn(malwareScanState);

    final MalwareScanState returnedMalwareScanState = new MalwareScanStatePersistenceRepository(persistenceInfra, objectMapperSupplier).load(FILE_ID);

    assertThat(returnedMalwareScanState).isNotNull();
    assertThat(returnedMalwareScanState.getFileId()).isEqualTo(malwareScanState.getFileId());

    verify(malwareScanStateKeyValueTable, times(1)).load(FILE_ID.getBytes(CHARSET));
    verify(objectMapper, times(1)).readValue(malwareScanStateBytes, MalwareScanState.class);
  }

  @Test
  public void load_valueIsNull_malwareScanStateReturned() throws Exception {
    when(malwareScanStateKeyValueTable.load(FILE_ID.getBytes(CHARSET))).thenReturn(null);

    final MalwareScanState returnedMalwareScanState = new MalwareScanStatePersistenceRepository(persistenceInfra, objectMapperSupplier).load(FILE_ID);

    assertThat(returnedMalwareScanState).isNull();

    verify(malwareScanStateKeyValueTable, times(1)).load(FILE_ID.getBytes(CHARSET));
    verify(objectMapper, times(0)).readValue(any(byte[].class), eq(MalwareScanState.class));
  }

  @Test
  public void load_jsonProcessingException_persistentExceptionThrown() throws Exception {
    final byte[] malwareScanStateBytes = ("{\"fileId\":\"" + FILE_ID + "\"}").getBytes(CHARSET);

    when(malwareScanStateKeyValueTable.load(FILE_ID.getBytes(CHARSET))).thenReturn(malwareScanStateBytes);
    when(objectMapper.readValue(malwareScanStateBytes, MalwareScanState.class)).thenThrow(new JsonMappingException(closeable, "JSON Mapping Exception"));

    assertThatThrownBy(() -> new MalwareScanStatePersistenceRepository(persistenceInfra, objectMapperSupplier)
        .load(FILE_ID)).isInstanceOf(PersistentException.class)
        .hasMessage("com.fasterxml.jackson.databind.JsonMappingException: JSON Mapping Exception");

    verify(malwareScanStateKeyValueTable, times(1)).load(FILE_ID.getBytes(CHARSET));
    verify(objectMapper, times(1)).readValue(malwareScanStateBytes, MalwareScanState.class);
  }

  @Test
  public void load_persistentException_persistentExceptionRethrown() throws Exception {
    when(malwareScanStateKeyValueTable.load(FILE_ID.getBytes(CHARSET))).thenThrow(new PersistentException("Failed to load", ""));

    assertThatThrownBy(() -> new MalwareScanStatePersistenceRepository(persistenceInfra, objectMapperSupplier)
        .load(FILE_ID)).isInstanceOf(PersistentException.class)
        .hasMessage("Failed to load");

    verify(malwareScanStateKeyValueTable, times(1)).load(FILE_ID.getBytes(CHARSET));
    verify(objectMapper, times(0)).readValue(any(byte[].class), eq(MalwareScanState.class));
  }

}
