package com.symphony.malware.scan.persistence.repository;

import com.symphony.data.infrastructure.IPersistenceInfra;
import com.symphony.data.mapper.IKeyValueTable;
import com.symphony.data.mapper.PersistentException;
import com.symphony.malware.scan.dto.MalwareScanState;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.CharEncoding;

import java.io.IOException;
import java.nio.charset.Charset;
import java.util.function.Supplier;

import javax.annotation.Nonnull;

@Slf4j
public class MalwareScanStatePersistenceRepository implements PersistenceRepository<String, MalwareScanState> {

  private static final Charset CHARSET = Charset.forName(CharEncoding.UTF_8);

  private static final String MALWARE_SCAN_STATE_TABLE = "malwareScanState";

  private final IKeyValueTable malwareScanStateKeyValueTable;
  private final Supplier<ObjectMapper> objectMapperSupplier;

  public MalwareScanStatePersistenceRepository(final IPersistenceInfra persistenceInfra, final Supplier<ObjectMapper> objectMapperSupplier) throws PersistentException {
    this.malwareScanStateKeyValueTable = persistenceInfra.getKeyValueTable(MALWARE_SCAN_STATE_TABLE);
    if (!malwareScanStateKeyValueTable.exist()) {
      LOGGER.info("Creating Malware Info table");
      malwareScanStateKeyValueTable.createTable();
    }

    this.objectMapperSupplier = objectMapperSupplier;
  }

  @Override
  public void save(@Nonnull final String fileId, @Nonnull final MalwareScanState malwareScanState) throws PersistentException {
    try {
      malwareScanStateKeyValueTable.save(fileId.getBytes(CHARSET), objectMapperSupplier.get().writeValueAsString(malwareScanState).getBytes(CHARSET));
    } catch (JsonProcessingException jpe) {
      throw new PersistentException(jpe, "Could not convert " + MalwareScanState.class.getSimpleName() + " to array of bytes");
    }
  }

  @Override
  public MalwareScanState load(@Nonnull final String fileId) throws PersistentException {
    try {
      final byte[] bytes = malwareScanStateKeyValueTable.load(fileId.getBytes(CHARSET));
      if (bytes != null) {
        return objectMapperSupplier.get().readValue(bytes, MalwareScanState.class);
      }
      return null;
    } catch (PersistentException pe) {
      throw pe;
    } catch (IOException ioe) {
      throw new PersistentException(ioe, "Could not convert array of bytes to " + MalwareScanState.class.getSimpleName());
    }
  }

}
